<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem-Pengundian</title>
    <link rel="stylesheet" href="style.css">
    <!-- Prevent browser requesting /favicon.ico and showing 404 in console -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">
</head>
<body>

    <!-- Navbar -->
    <nav id="navbar" class="navbar">
        <div class="nav-container">
            <div class="brand">
                <span>Sistem Pengundian</span>
                <small>Kelab Komputer</small>
            </div>
            <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links" id="navLinks">
                <button id="homeNavBtn" class="nav-btn" onclick="showSection('home')">Utama</button>
                <button id="signupNavBtn" class="nav-btn" onclick="showSection('signup')">Daftar</button>
                <button id="signinNavBtn" class="nav-btn" onclick="showSection('signin')">Log Masuk</button>
                <button id="adminSignInNavBtn" class="nav-btn ghost" onclick="window.location.href='admin.html'">Admin</button>
                <button id="logoutNavBtn" class="nav-btn primary" style="display:none;" onclick="logout()">Log Keluar</button>
                <button id="adminNavBtn" class="nav-btn" style="display:none;" onclick="showSection('admin')">Panel Admin</button>
            </div>
        </div>
    </nav>

    <main>
        <!-- Home / Hero -->
        <div id="home-section" class="home-section">
            <section class="hero">
                <div class="hero-text">
                    <p class="eyebrow">Undian digital yang telus & pantas</p>
                    <h1>Urus dan pantau pengundian jawatankuasa kelab dalam satu papan pemuka moden.</h1>
                    <p class="lead">Benarkan pelajar mendaftar, log masuk dan mengundi dengan mudah sambil pihak pentadbir memantau kemajuan secara masa nyata.</p>
                    <div class="hero-actions">
                        <button class="btn primary" onclick="showSection('signup')">Mula Daftar</button>
                        <button class="btn ghost" onclick="showSection('signin')">Saya sudah berdaftar</button>
                    </div>
                    <ul class="hero-stats">
                        <li>
                            <strong>100%</strong>
                            <span>Jejak audit terperinci</span>
                        </li>
                        <li>
                            <strong>&lt;2 min</strong>
                            <span>Tempoh purata daftar</span>
                        </li>
                        <li>
                            <strong>24/7</strong>
                            <span>Akses kepada pentadbir</span>
                        </li>
                    </ul>
                </div>
                <div class="hero-card">
                    <div class="card-head">
                        <p class="eyebrow">Status Sesi</p>
                        <span class="badge success">Aktif</span>
                    </div>
                    <h3>Pengundian Kelab Komputer</h3>
                    <div class="pill-list">
                        <span class="pill">Pengerusi</span>
                        <span class="pill">Naib Pengerusi</span>
                        <span class="pill">Setiausaha</span>
                        <span class="pill">Bendahari</span>
                    </div>
                    <button class="btn w-100" onclick="showSection('signin')">Teruskan ke undian</button>
                </div>
            </section>

            <section class="feature-section" aria-label="Ciri utama">
                <div class="section-heading">
                    <p class="eyebrow">Ciri utama</p>
                    <h2>Direka untuk pengalaman mengundi kampus yang profesional.</h2>
                </div>
                <div class="feature-grid">
                    <article class="feature-card">
                        <h3>Reka bentuk responsif</h3>
                        <p>Boleh dicapai pada telefon, tablet dan desktop tanpa perlu pasang aplikasi tambahan.</p>
                    </article>
                    <article class="feature-card">
                        <h3>Laporan masa nyata</h3>
                        <p>Pentadbir melihat jumlah undian dan aktiviti pengguna serta dapat memuat turun laporan.</p>
                    </article>
                    <article class="feature-card">
                        <h3>Akses selamat</h3>
                        <p>Autentikasi berlapis memastikan hanya ahli kelab yang sah boleh mengundi.</p>
                    </article>
                </div>
            </section>

            <section class="steps-section" aria-label="Cara menggunakan">
                <div class="section-heading">
                    <p class="eyebrow">3 langkah mudah</p>
                    <h2>Lengkapkan sesi undian dalam masa kurang 5 minit.</h2>
                </div>
                <ol class="steps-list">
                    <li>
                        <span class="step-number">01</span>
                        <div>
                            <h3>Daftar akaun ahli</h3>
                            <p>Isi maklumat asas dan sahkan emel pelajar untuk akses sistem.</p>
                        </div>
                    </li>
                    <li>
                        <span class="step-number">02</span>
                        <div>
                            <h3>Log masuk & semak calon</h3>
                            <p>Pilih jawatan yang ingin diundi dan teliti biodata calon.</p>
                        </div>
                    </li>
                    <li>
                        <span class="step-number">03</span>
                        <div>
                            <h3>Hantar undian anda</h3>
                            <p>Sistem mengunci jawatan yang telah diundi untuk mengelak pengundian berganda.</p>
                        </div>
                    </li>
                </ol>
            </section>

            <section class="cta-panel">
                <div>
                    <p class="eyebrow">Sedia untuk bermula?</p>
                    <h2>Aktifkan akaun anda hari ini dan pantau undian secara telus.</h2>
                </div>
                <div class="cta-actions">
                    <button class="btn primary" onclick="showSection('signup')">Buka borang pendaftaran</button>
                    <button class="btn ghost" onclick="showSection('signin')">Log masuk sebagai ahli</button>
                </div>
            </section>
        </div>

        <!-- Voting area (shown after login) -->
        <section id="vote-section" class="panel vote-panel" style="display:none;">
            <div class="panel-header">
                <div>
                    <p class="eyebrow">Sesi undian aktif</p>
                    <h2>Pilih jawatan untuk diundi</h2>
                    <p>Setiap jawatan hanya boleh diundi sekali bagi memastikan ketelusan.</p>
                </div>
                <span class="badge neutral">Langkah 2</span>
            </div>
            <form id="voteForm" method="POST" action="#" class="form-grid">
                <div class="form-control">
                    <label for="position">Pilih jawatan</label>
                    <select name="position" id="position" required>
                        <option value="">-- Pilih Jawatan --</option>
                    </select>
                </div>
                <div class="form-control">
                    <label for="student">Pilih calon</label>
                    <select name="student" id="student" required>
                        <option value="">-- Pilih Calon --</option>
                    </select>
                </div>
                <div class="form-action">
                    <button id="voteSubmit" type="button" class="btn primary w-100">Undi sekarang</button>
                </div>
            </form>
            <div id="result" class="form-result"></div>
        </section>
        <p id="vote-login-msg" class="helper-text" style="display:none;">Sila log masuk untuk mengundi.</p>

        <section id="signup-section" class="auth-section" style="display:none;">
            <div class="section-heading compact">
                <p class="eyebrow">Langkah pertama</p>
                <h2>Buka akaun pelajar</h2>
                <p>Pendaftaran membenarkan anda mengundi dan menyemak status calon.</p>
            </div>
            <form id="signupForm" class="auth-form">
                <input type="hidden" name="action" value="signup">
                <label for="signup_username">ID Pengguna</label>
                <input type="text" id="signup_username" name="username" required placeholder="Contoh: D6261">
                <label for="signup_nama">Nama Penuh</label>
                <input type="text" id="signup_nama" name="nama" required placeholder="Contoh: Ali bin Ahmad">
                <label for="signup_password">Kata Laluan</label>
                <input type="password" id="signup_password" name="password" required>
                <button type="submit" class="btn primary w-100">Daftar</button>
            </form>
            <div id="signup-result" class="form-result"></div>
        </section>

        <section id="signin-section" class="auth-section" style="display:none;">
            <div class="section-heading compact">
                <p class="eyebrow">Kembali mengundi</p>
                <h2>Log masuk akaun anda</h2>
                <p>Masukkan butiran akaun yang sama seperti ketika pendaftaran.</p>
            </div>
            <form id="signinForm" class="auth-form">
                <input type="hidden" name="action" value="signin">
                <label for="signin_username">ID Pengguna</label>
                <input type="text" id="signin_username" name="username" required placeholder="Contoh: D6261">
                <label for="signin_password">Kata Laluan</label>
                <input type="password" id="signin_password" name="password" required>
                <button type="submit" class="btn primary w-100">Log Masuk</button>
            </form>
            <div id="signin-result" class="form-result"></div>
        </section>

        <section id="admin-section" class="admin-section" style="display:none;">
            <div class="section-heading compact">
                <p class="eyebrow">Panel pentadbiran</p>
                <h2>Jejaki pengguna dan undian</h2>
                <p>Gunakan tindakan pantas di bawah untuk menghasilkan laporan.</p>
            </div>
            <div class="admin-actions">
                <button class="btn secondary" onclick="viewUsers()">Lihat semua pengguna</button>
                <button class="btn primary" onclick="viewVotes()">Lihat semua undian</button>
            </div>
            <div id="admin-output" class="admin-output"></div>
        </section>
    </main>

    <script>
    // Section navigation
    function showSection(section) {
        document.getElementById('home-section').style.display = (section === 'home') ? 'block' : 'none';
        document.getElementById('signup-section').style.display = (section === 'signup') ? 'block' : 'none';
        document.getElementById('signin-section').style.display = (section === 'signin') ? 'block' : 'none';
        document.getElementById('admin-section').style.display = (section === 'admin') ? 'block' : 'none';
        // Only show vote-section when on home and a non-admin user is logged in
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        if (section === 'home' && isLoggedIn && !isAdmin) {
            document.getElementById('vote-section').style.display = 'block';
            document.getElementById('vote-login-msg').style.display = 'none';
        } else if (section !== 'home') {
            document.getElementById('vote-section').style.display = 'none';
        }
    }

    // Show admin nav if user is admin (demo, real check is server-side)
    function updateVoteVisibility() {
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        document.getElementById('adminNavBtn').style.display = isAdmin ? 'inline-block' : 'none';
    // Show admin sign-in link only when not admin
    document.getElementById('adminSignInNavBtn').style.display = (!isAdmin && !isLoggedIn) ? 'inline-block' : 'none';
        document.getElementById('signupNavBtn').style.display = isLoggedIn ? 'none' : 'inline-block';
        document.getElementById('signinNavBtn').style.display = isLoggedIn ? 'none' : 'inline-block';
        document.getElementById('logoutNavBtn').style.display = isLoggedIn ? 'inline-block' : 'none';

        if (isLoggedIn && !isAdmin) {
            // Show vote section only for non-admin users when on home
            if (document.getElementById('home-section').style.display !== 'none') {
                document.getElementById('vote-section').style.display = 'block';
                document.getElementById('vote-login-msg').style.display = 'none';
            } else {
                document.getElementById('vote-section').style.display = 'none';
            }
        } else {
            // hide vote section for admins and for anonymous users
            document.getElementById('vote-section').style.display = 'none';
            // show login prompt only when not logged in at all
            document.getElementById('vote-login-msg').style.display = isLoggedIn ? 'none' : 'block';
        }
    // Refresh vote controls (disable if already voted client-side)
    try { updateVoteControls(); } catch (e) { /* ignore if helper not yet defined */ }
    }
    updateVoteVisibility();

    // Server-backed enforcement: fetch positions this user already voted for from PHP
    let serverVotedPositions = [];
    async function fetchVotedPositionsFromServer() {
        serverVotedPositions = [];
        try {
            const res = await fetch('index.php?action=my_votes', { credentials: 'same-origin' });
            if (!res.ok) return;
            const json = await res.json();
            if (Array.isArray(json)) serverVotedPositions = json;
        } catch (e) { /* ignore */ }
        updateVoteControls();
    }
    function hasVotedPosition(position) {
        return serverVotedPositions.includes(position);
    }
    function updateVoteControls() {
        const positionEl = document.getElementById('position');
        const voteBtn = document.getElementById('voteSubmit');
        if (!positionEl || !voteBtn) return;
        const pos = positionEl.value;
        if (!pos) {
            voteBtn.disabled = false;
            voteBtn.textContent = 'Undi';
            return;
        }
        if (hasVotedPosition(pos)) {
            voteBtn.disabled = true;
            voteBtn.textContent = 'Sudah Mengundi untuk ' + pos;
        } else {
            voteBtn.disabled = false;
            voteBtn.textContent = 'Undi';
        }
    }

    // Observe changes to position select to refresh controls
    const posEl = document.getElementById('position');
    if (posEl) {
        posEl.addEventListener('change', updateVoteControls);
        // initial update
        updateVoteControls();
    }

    function logout() {
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isAdmin');
        updateVoteVisibility();
        showSection('home');
    }

    // Sign Up AJAX
    const signupFormEl = document.getElementById('signupForm');
    if (signupFormEl) {
        signupFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            fetch('index.php', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                const out = document.getElementById('signup-result');
                if (out) out.textContent = data;
                if (data.includes('Pendaftaran berjaya')) {
                    if (out) out.style.color = '#27ae60';
                    form.reset();
                } else {
                    if (out) out.style.color = '#c0392b';
                }
            });
        });
    }

    // Sign In AJAX
    const signinFormEl = document.getElementById('signinForm');
    if (signinFormEl) {
        signinFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            fetch('index.php', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                const el = document.getElementById('signin-result');
                if (el) el.textContent = data;
                const lower = (data || '').toLowerCase();
                // If server returns words like 'gagal', 'salah', or 'tidak', treat as failure
                const isFailure = /gagal|salah|tidak/.test(lower);
                const isSuccess = !isFailure && lower.includes('log masuk');
                if (isSuccess) {
                    if (el) el.style.color = '#27ae60';
                    localStorage.setItem('isLoggedIn', 'true');
                    if (lower.includes('admin')) {
                        localStorage.setItem('isAdmin', 'true');
                    }
                    updateVoteVisibility();
                    // Auto-direct to home after successful sign-in
                    showSection('home');
                    setTimeout(() => {
                        if (el) el.textContent = '';
                        form.reset();
                    }, 1200);
                } else {
                    if (el) el.style.color = '#c0392b';
                    // Keep sign-in section visible so error message stays
                    showSection('signin');
                }
            });
        });
    }

    // Admin AJAX functions
    function viewUsers() {
    fetch('index.php?action=view_users', { credentials: 'same-origin' })
            .then(res => res.text())
            .then(data => document.getElementById('admin-output').innerHTML = data);
    }
    function viewVotes() {
    fetch('index.php?action=view_votes', { credentials: 'same-origin' })
            .then(res => res.text())
            .then(data => document.getElementById('admin-output').innerHTML = data);
    }

    // Simple mobile nav toggle
    const navToggle = document.getElementById('navToggle');
    const navLinks = document.getElementById('navLinks');
    if (navToggle && navLinks) {
        navToggle.addEventListener('click', () => {
            const expanded = navToggle.getAttribute('aria-expanded') === 'true';
            navToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');
            navLinks.classList.toggle('is-open');
        });
        navLinks.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                if (navLinks.classList.contains('is-open')) {
                    navLinks.classList.remove('is-open');
                    navToggle.setAttribute('aria-expanded', 'false');
                }
            });
        });
    }
    </script>
    <script src="script.js"></script>
</body>
</html>